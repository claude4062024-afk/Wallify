---
/**
 * TestimonialCard Component
 * Displays a single testimonial with author info, rating, and content
 * 
 * Following Skill.md Astro standards:
 * - Ships zero JavaScript by default
 * - Semantic HTML for accessibility
 * - Optimized for Core Web Vitals
 */

import type { Testimonial } from '../lib/supabase';
import { formatRelativeTime, getInitials, getStarArray } from '../lib/utils';

interface Props {
  testimonial: Testimonial;
  showRating?: boolean;
  showDate?: boolean;
}

const { testimonial, showRating = true, showDate = true } = Astro.props;

const stars = getStarArray(testimonial.rating);
const initials = getInitials(testimonial.author_name);
---

<article class="testimonial-card">
  <!-- Author Avatar -->
  <div class="testimonial-header">
    {testimonial.author_avatar ? (
      <img 
        src={testimonial.author_avatar} 
        alt={`${testimonial.author_name}'s photo`}
        class="avatar"
        loading="lazy"
        width="48"
        height="48"
      />
    ) : (
      <div class="avatar-placeholder" aria-hidden="true">
        {initials}
      </div>
    )}
    
    <div class="author-info">
      <h3 class="author-name">{testimonial.author_name}</h3>
      {(testimonial.author_title || testimonial.author_company) && (
        <p class="author-role">
          {testimonial.author_title}
          {testimonial.author_title && testimonial.author_company && ' at '}
          {testimonial.author_company}
        </p>
      )}
    </div>
  </div>

  <!-- Rating Stars -->
  {showRating && testimonial.rating && (
    <div class="rating" role="img" aria-label={`Rating: ${testimonial.rating} out of 5 stars`}>
      {stars.map((star) => (
        <svg 
          class={`star star-${star}`} 
          viewBox="0 0 20 20" 
          fill="currentColor"
          width="20"
          height="20"
          aria-hidden="true"
        >
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
        </svg>
      ))}
    </div>
  )}

  <!-- Content -->
  <blockquote class="testimonial-content">
    <p>{testimonial.content_text}</p>
  </blockquote>

  <!-- Media (if video/image) -->
  {testimonial.media_url && testimonial.media_type === 'video' && (
    <div class="testimonial-media">
      <video 
        src={testimonial.media_url} 
        controls 
        preload="metadata"
        class="video-player"
        aria-label={`Video testimonial from ${testimonial.author_name}`}
      >
        Your browser does not support video playback.
      </video>
    </div>
  )}

  {testimonial.media_url && testimonial.media_type === 'image' && (
    <div class="testimonial-media">
      <img 
        src={testimonial.media_url} 
        alt={`Image from ${testimonial.author_name}`}
        class="media-image"
        loading="lazy"
      />
    </div>
  )}

  <!-- Date -->
  {showDate && (
    <time class="testimonial-date" datetime={testimonial.created_at}>
      {formatRelativeTime(testimonial.created_at)}
    </time>
  )}

  <!-- Tags -->
  {testimonial.tags && testimonial.tags.length > 0 && (
    <div class="testimonial-tags">
      {testimonial.tags.slice(0, 3).map((tag) => (
        <span class="tag">{tag}</span>
      ))}
    </div>
  )}
</article>

<style>
  .testimonial-card {
    background: white;
    border-radius: var(--border-radius, 12px);
    padding: 1.5rem;
    box-shadow: var(--card-shadow, 0 4px 6px -1px rgb(0 0 0 / 0.1));
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .testimonial-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .avatar,
  .avatar-placeholder {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .avatar {
    object-fit: cover;
  }

  .avatar-placeholder {
    background: linear-gradient(135deg, var(--color-primary, #f59e0b), #fbbf24);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
  }

  .author-info {
    min-width: 0;
  }

  .author-name {
    font-size: 1rem;
    font-weight: 600;
    color: #1c1917;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .author-role {
    font-size: 0.875rem;
    color: #78716c;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .rating {
    display: flex;
    gap: 0.125rem;
  }

  .star {
    width: 20px;
    height: 20px;
  }

  .star-full {
    color: #f59e0b;
  }

  .star-half {
    color: #f59e0b;
    opacity: 0.5;
  }

  .star-empty {
    color: #d6d3d1;
  }

  .testimonial-content {
    margin: 0;
    border: none;
    padding: 0;
  }

  .testimonial-content p {
    font-size: 1rem;
    line-height: 1.7;
    color: #44403c;
    margin: 0;
  }

  .testimonial-media {
    border-radius: 8px;
    overflow: hidden;
  }

  .video-player,
  .media-image {
    width: 100%;
    display: block;
  }

  .testimonial-date {
    font-size: 0.75rem;
    color: #a8a29e;
  }

  .testimonial-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: #f5f5f4;
    color: #57534e;
    border-radius: 4px;
  }
</style>
